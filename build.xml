<project name="Sample usage of Salesforce Ant tasks" basedir="." xmlns:sf="antlib:task" xmlns:if="ant:if" xmlns:unless="ant:unless" default="deploy">

	<property name="file.checksums.local" value="timestamps-updated.log"/>
	<!-- This property is for debugging only. If set to true, no changes will be applied to the metadata in SFDC and the local checksums file. -->
	<property name="dryrun" value="false"/>
	
    <property prefix="sfdc" file="build.properties" unless:set="CI"/>
	
	<presetdef name="deploy">
		<sf:deploy
				debug="${sfdc.debug}" dryRun="${dryrun}"
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}" maxPoll="${sfdc.maxPoll}" 
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}" deployRoot="src/main/metadata"
				transformationsRoot="src/main/transformations" checksums="${file.checksums.local}"/>
	</presetdef>
	
	<presetdef name="loadData">
		<sf:loadData
				debug="${sfdc.debug}"
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}"
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}" 
				dataRoot="src/main/resources/data" logDir="logs"/>
	</presetdef>
	
	<target name="gitVersion">
		<exec executable="git" outputproperty="git.version">
			<arg line="rev-parse HEAD"/>
		</exec>
		<echo message="Git version is ${git.version}."/>
	</target>
	
	<target name="deployAll">
		<delete file="${file.checksums.local}" quiet="true"/>
		<property name="skip.checksum.retrieval" value="true"/>
		<antcall target="deploy"/>
	</target>
	
	<target name="retrieveChecksums">
		<sf:retrieveChecksums unless:set="skip.checksum.retrieval"
				sfdcName="${sfdc.checksums}" dryRun="${dryrun}" checksums="${file.checksums.local}"
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}" maxPoll="${sfdc.maxPoll}" 
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}" />
	</target>
	
	<target name="deploy" depends="gitVersion, retrieveChecksums, preDestructiveChanges, deploy01, deploy05, deploy07, deploy09, deploy10, deploy12, deploy15, deploy20, deploy21, deploy25, deploy30, deploy32, deploy35, deploy40, postDestructiveChanges">
		<sf:deployChecksums sfdcName="${sfdc.checksums}" dryRun="${dryrun}" gitVersion="${git.version}"
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}" maxPoll="${sfdc.maxPoll}" 
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}" checksums="${file.checksums.local}"/>
		<fail if:set="failed.deploy.step" message="Deployment failed in step ${failed.deploy.step}."/>
	</target>
	
	<target name="preDestructiveChanges">
		<!-- on CI server only deploy destructive changes which have a valid timestamp already -->
		<property name="persistedOnly" value="false" unless:set="CI"/>
		<property name="persistedOnly" value="true" if:set="CI"/>
		
		<sf:deployDestructiveChanges
				dryRun="${dryrun}" persistedOnly="${persistedOnly}" mode="pre" debug="${sfdc.debug}"
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}" maxPoll="${sfdc.maxPoll}" 
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}"
				deployRoot="src/main/destructive" destructiveFile="destructive.properties" checksums="${file.checksums.local}"/>
	</target>

	<target name="postDestructiveChanges">
		<!-- on CI server only deploy destructive changes which have a valid timestamp already -->
		<property name="persistedOnly" value="false" unless:set="CI"/>
		<property name="persistedOnly" value="true" if:set="CI"/>
		
		<sf:deployDestructiveChanges
				dryRun="${dryrun}" persistedOnly="${persistedOnly}" mode="post" debug="${sfdc.debug}"
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}" maxPoll="${sfdc.maxPoll}" 
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}"
				deployRoot="src/main/destructive" destructiveFile="destructive.properties" checksums="${file.checksums.local}"/>
	</target>
	
	<target name="deploy01">
		<deploy>
			<sf:typeset name="labels"/>
			<sf:typeset name="staticresources">
				<!-- the Checksums resource is handled by separate tasks -->
				<sf:exclude name="Checksums"/>
			</sf:typeset>
			<sf:typeset name="remoteSiteSettings"/>
			<sf:typeset name="roles"/>
			<sf:typeset name="queues"/>
		</deploy>
    </target>
	
	<target name="deploy05">
		<deploy>			
			<sf:typeset name="documents"/>
			<sf:typeset name="callCenters"/>
		</deploy>
    </target>
	
	<target name="deploy07">
		<deploy>
			<sf:typeset name="objects">
				<sf:include name="Picklist_Mapping__c"/>
				<sf:include name="Integration_Picklist__c"/>
				<sf:include name="External_Picklist__c"/>
				<sf:include name="Car_Model__c"/>
			</sf:typeset>
		</deploy>
    </target>
	
	<target name="deploy09">
		<deploy>
			<sf:typeset name="objects">
			    <sf:include name="Contact"/>
				<sf:include name="PersonAccount"/>
				<sf:include name="Account"/>
			</sf:typeset>
		</deploy>
    </target>

	<target name="deploy10">
		<deploy>
			<sf:typeset name="objects">
			    <sf:include name=".*__c"/>
				<sf:exclude name="Picklist_Mapping__c"/>
				<sf:exclude name="Integration_Picklist__c"/>
				<sf:exclude name="External_Picklist__c"/>
				<sf:exclude name="Car_Model__c"/>
				<sf:exclude name="SMS_Batch__c"/>
				<sf:exclude name="Retail_Campaign__c"/>
				<sf:exclude name="OB_Task_Handing__c"/>
				<sf:exclude name="Retail_Campaign_Member__c"/>
				<sf:exclude name="Lead__c"/>
				<sf:exclude name="Campaign_Lead__c"/>
				<sf:exclude name="DM_Request__c"/>
				<sf:exclude name="SurveyTaker__c"/>
				<sf:exclude name="SurveyQuestionResponse__c"/>
				<sf:exclude name="Contract_Relation__c"/>
			</sf:typeset>
		</deploy>
    </target>
	
	<target name="deploy12">
		<deploy>
			<sf:typeset name="objects">
				<sf:include name="Campaign"/>
			</sf:typeset>
		</deploy>
    </target>
	
	<target name="deploy15">
		<deploy>
			<sf:typeset name="objects">
				<sf:include name="Lead__c"/>
				<sf:include name="Campaign_Lead__c"/>
				<sf:include name="DM_Request__c"/>
				<sf:include name="SMS_Batch__c"/>
				<sf:include name="Retail_Campaign__c"/>
				<sf:include name="OB_Task_Handing__c"/>
				<sf:include name="Retail_Campaign_Member__c"/>
				<sf:include name="SurveyTaker__c"/>
				<sf:include name="SurveyQuestionResponse__c"/>
			</sf:typeset>
		</deploy>
    </target>
	
	<target name="deploy20">
		<deploy>
			<sf:typeset name="objects">
				<sf:exclude name="Account"/>
				<sf:exclude name="PersonAccount"/>
				<sf:exclude name="Contact"/>
				<sf:exclude name="Campaign"/>
				<sf:exclude name="Task"/>
				<sf:exclude name="Activity"/>
				<!-- TODO FALK check this: do not deploy site -->
				<sf:exclude name="Site"/>
			    <sf:exclude name=".*__c"/>
			</sf:typeset>
		</deploy>
    </target>
	
	<target name="deploy21">
		<deploy>
			<sf:typeset name="objects">
				<sf:include name="Contract_Relation__c"/>
			</sf:typeset>
			<sf:typeset name="settings"/>
			<sf:typeset name="tabs">
				<sf:exclude name="EPA_.*"/>
				<sf:exclude name="Tasks"/>
				<sf:exclude name="Retail_Campaigns"/>
				<sf:exclude name="Central_Campaigns"/>
				<sf:exclude name="Campaign_Calendar"/>
				<sf:exclude name="Retail_Campaign__c"/>	
				<sf:exclude name="Retail_Campaign_Calender"/>
				<sf:exclude name="Yearly_Target"/>
			</sf:typeset>
			<sf:typeset name="layouts">
				<sf:exclude name="Campaign.*"/>
				<sf:exclude name="Event.*"/>
				<sf:exclude name="Task.*"/>
				<sf:exclude name="Case.*"/>
				<sf:exclude name="PersonAccount.*"/>
				<sf:exclude name="Lead__c.*"/>
			</sf:typeset>
			<sf:typeset name="email"/>
			<sf:typeset name="groups"/>
			<sf:typeset name="workflows">
				<sf:exclude name="Task"/>
				<sf:exclude name="Tool_Kit__c"/>
				<sf:exclude name="Retail_Campaign__c"/>
			</sf:typeset>
		</deploy>
    </target>
	
	<target name="deploy25">			
		<deploy>
			<sf:typeset name="pages">
				<sf:include name="Tasks"/>
			</sf:typeset>
			<sf:typeset name="tabs">
				<sf:include name="Tasks"/>
			</sf:typeset>
			<sf:typeset name="classes">
				<sf:include name="TaskDeletingController"/>
			</sf:typeset>
			<sf:typeset name="pages">
				<sf:include name="TaskDeleting"/>
			</sf:typeset>
			<sf:typeset name="objects">
				<sf:include name="Task"/>
				<sf:include name="Activity"/>
			</sf:typeset>
		</deploy>
    </target>
	
	<target name="deploy30">
		<deploy>
			<sf:typeset name="classes"/>
			<sf:typeset name="components"/>
			<sf:typeset name="pages"/>
			<sf:typeset name="tabs">
				<sf:include name="EPA_.*"/>
				<sf:include name="Tasks"/>
				<sf:include name="Retail_Campaigns"/>
				<sf:include name="Central_Campaigns"/>
				<sf:include name="Campaign_Calendar"/>
				<sf:include name="Retail_Campaign__c"/>	
				<sf:include name="Retail_Campaign_Calender"/>
				<sf:include name="Yearly_Target"/>
			</sf:typeset>
			<sf:typeset name="triggers"/>
		</deploy>
    </target>
	
	<target name="deploy32">
		<deploy>
			<sf:typeset name="layouts">
				<sf:include name="Campaign.*"/>
				<sf:include name="Event.*"/>
				<sf:include name="Task.*"/>
				<sf:include name="Case.*"/>
				<sf:include name="PersonAccount.*"/>
				<sf:include name="Lead__c.*"/>
			</sf:typeset>
			<sf:typeset name="workflows">
				<sf:include name="Task"/>
				<sf:include name="Tool_Kit__c"/>
				<sf:include name="Retail_Campaign__c"/>
			</sf:typeset>
		</deploy>
    </target>
	
	<target name="deploy35">
		<deploy>
			<sf:typeset name="applications"/>
			<sf:typeset name="permissionsets"/>
			<sf:typeset name="profiles"/>
			<sf:typeset name="weblinks"/>
			<sf:typeset name="homePageComponents"/>
			<sf:typeset name="homePageLayouts"/>
			<!-- TODO commented the AppSwitcher appMenu, it is a known salesforce issue and it is failing during deployment -->
			<sf:typeset name="appMenus">
				<sf:exclude name="AppSwitcher"/>
			</sf:typeset>
		</deploy>
	</target>
	
	<target name="deploy40">
		<deploy>
			<sf:typeset name="accountSharingRules"/>
			<sf:typeset name="campaignSharingRules"/>
			<sf:typeset name="caseSharingRules"/>
			<sf:typeset name="customObjectSharingRules"/>
			<sf:typeset name="approvalProcesses"/>
		</deploy>
    </target>

	<target name="loaddata-oliver">
		<mkdir dir="logs"/>
		<loadData logDir="logs" configId="oliverkoethap1__Environment_Specific_Values__c"/>
	</target>
	
	<target name="loaddata">
		<mkdir dir="logs"/>
		<loadData logDir="logs" configId="Environment_Specific_Values__c"/>
	</target>
	
	<target name="loaddata-trigger">
		<mkdir dir="logs"/>
		<loadData logDir="logs" configId="Trigger__c"/>
	</target>
	
	<property name="typesets.circle">
		CustomLabels,CallCenter,CustomTab,ApexClass,ApexComponent,ApexPage,ApexTrigger,Group,Queue,Document,AccountSharingRules,CustomPageWebLink,Role,ApprovalProcess,PermissionSet,CustomObject,Layout,
		Workflow,CampaignSharingRules,EmailTemplate,CustomApplication,AppMenu,CaseSharingRules,CustomObjectSharingRules,Settings,HomePageComponent,HomePageLayout,RemoteSiteSetting,StaticResource,Profile
	</property>
	
	<property name="typesets.not-ready">
	</property>
	
	<target name="retrieve" depends="gitVersion">
		<sf:checkChecksumsVersion
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}" maxPoll="${sfdc.maxPoll}" 
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}"
				gitVersion="${git.version}" sfdcName="${sfdc.checksums}" dryRun="${dryrun}" checksums="${file.checksums.local}" />
	
		<!-- retrieves all metadata -->
		<sf:retrieve
				debug="${sfdc.debug}" dryRun="${dryrun}" cleanupOther="false"
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}" maxPoll="${sfdc.maxPoll}" 
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}" 
				retrieveRoot="src/main/metadata" transformationsRoot="src/main/transformations">
			<sf:typesets names="${typesets.circle}"/>
			<sf:feature name="exclude-checksums" param="Checksums"/>
			<sf:feature name="include-personaccount"/>
		</sf:retrieve>
		
		<!-- retrieves all metadata -->
		<!--sf:retrieve
				debug="${sfdc.debug}" dryRun="false" cleanupOther="true"
				username="${sfdc.username}" password="${sfdc.password}" serverurl="${sfdc.serverurl}" maxPoll="${sfdc.maxPoll}" 
				useProxy="${sfdc.proxy.use}" proxyHost="${sfdc.proxy.host}" proxyPort="${sfdc.proxy.port}" 
				retrieveRoot="src/main/metadata-retrieve" transformationsRoot="src/main/transformations" timestamps="timestamps-deployed.log">
			<sf:typesets names="${typesets.not-ready}"/>
			<sf:feature name="include-personaccount"/>
		</sf:retrieve-->
		
		<sf:finalizeDestructiveChanges
				dryRun="${dryrun}" deployRoot="src/main/destructive" destructiveFile="destructive.properties" checksums="${file.checksums.local}"/>
	</target>
	
</project>
