<apex:page standardController="SMS__c" extensions="SMSControllerExtension" showHeader="false" id="page"> 
    <apex:includeScript value="/support/console/28.0/integration.js"/>
    <apex:includeScript value="/soap/ajax/28.0/apex.js"/>
    <script type="text/javascript">
        function setMobileCheckbox(id)
        {
            if(document.getElementById(id).checked)
            {
                if("{!customer.PersonMobilePhone}" == '' || "{!customer.PersonMobilePhone}" == null)
                {
                    alert('Mobile is blank, you couldn\'t choose it');
                    document.getElementById(id).checked = false;
                }
                else
                {
                    document.getElementById(id.replace('1', '2').replace('1', '2')).checked = false;
                }
            }
            else
            {
                if("{!customer.PersonOtherPhone}" == '' || "{!customer.PersonOtherPhone}" == null)
                {
                    alert('Secondary mobile is blank, you couldn\'t choose it');
                    document.getElementById(id.replace('1', '2').replace('1', '2')).checked = false;
                }
                else
                {
                    document.getElementById(id.replace('1', '2').replace('1', '2')).checked = true;
                }
            }
        }
        function setMobileCheckbox2(id)
        {
            if(document.getElementById(id).checked)
            {
                if("{!customer.PersonOtherPhone}" == '' || "{!customer.PersonOtherPhone}" == null)
                {
                    alert('Secondary mobile is blank, you couldn\'t choose it.');
                    document.getElementById(id).checked = false;
                }
                else
                {
                    document.getElementById(id.replace('2', '1').replace('2', '1')).checked = false;
                }
            }
            else
            {
                if("{!customer.PersonMobilePhone}" == '' || "{!customer.PersonMobilePhone}" == null)
                {
                    alert('Mobile is blank, you couldn\'t choose it');
                    document.getElementById(id).checked = false;
                }
                else
                {
                    document.getElementById(id.replace('2', '1').replace('2', '1')).checked = true;
                }   
            }
        }

        function CloseTab() {
            sforce.console.getEnclosingTabId(closeSubtab);
            sforce.console.refreshPrimaryTabById("{!$Request.tabId}", true, refreshSuccess );
        }
        var closeSubtab = function closeSubtab(result) {
            var tabId = result.id;
            sforce.console.closeTab(tabId);
        };
        
        var refreshSuccess = function refreshSuccess(result) { };

        function SendAndClose()
        {
            if (sforce.console.isInConsole()) {
                CloseTab();
            }
            else {
                window.close();
            }
        }
        
    </script>
    <apex:sectionHeader title="{!IF($CurrentPage.Parameters.type == 'sms', '短信', '彩信')}" />
    <apex:form id="theForm">
        <apex:pageMessages />
        <apex:pageBlock mode="edit" title="发送{!IF($CurrentPage.Parameters.type == 'sms', '短信', '彩信')}" id="smsBlock" >
            <apex:pageBlockButtons >
                <apex:commandButton value="发送" action="{!send}" onComplete="SendAndClose();"/>
                <apex:commandButton value="取消" immediate="true" onclick="CloseTab();"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection title="信息" columns="2" id="smsBlockSection">
                <apex:outputField value="{!sms.CustomerName__c}"/>
                
                <apex:pageBlockSectionItem labelstyle="label" datastyle="inputText" id="smsBlockSectionItem1">
                    <apex:outputPanel >
                        <b><apex:outputLabel value="手机号"/></b>
                    </apex:outputPanel>       
                    <apex:outputPanel id="smsBlockSectionItemPanel1">
                        <apex:inputField value="{!sms.Mobile__c}" id="smsBlockSectionItemPanel1Mobile" onchange="setMobileCheckbox(this.id);"/> 
                        <apex:outputField value="{!customer.PersonMobilePhone}"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                
                <apex:inputField value="{!sms.Dealer__c}"/>
                
                <apex:pageBlockSectionItem labelstyle="label" datastyle="inputText" id="smsBlockSectionItem2">
                    <apex:outputPanel >
                        <b><apex:outputLabel value="备选手机号"/></b>
                    </apex:outputPanel>       
                    <apex:outputPanel id="smsBlockSectionItemPanel2">
                        <apex:inputField value="{!sms.Secondary_Mobile__c}" id="smsBlockSectionItemPanel2Mobile" onchange="setMobileCheckbox2(this.id);"/> 
                        <apex:outputField value="{!customer.PersonOtherPhone}"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem> 
                
                <apex:pageBlockSectionItem labelstyle="label" datastyle="inputText">
                    <apex:outputPanel >
                        <b>
                            <apex:outputLabel style="align:right;" for="templateList" value="{!IF($CurrentPage.Parameters.type == 'sms', '短信', '彩信')}模板"/>
                        </b>
                    </apex:outputPanel>       
                    <apex:outputPanel layout="block" styleClass="requiredInput">
                        <apex:outputPanel layout="block" styleClass="requiredBlock" rendered="true"></apex:outputPanel>
                        <apex:outputPanel >
                            <apex:selectList id="templateList" value="{!templateId}" size="1" styleClass="requiredInput"> 
                                <apex:selectOptions value="{!Templates}"/>
                                <apex:actionSupport event="onchange" action="{!parseTemplateMessage}" rerender="theForm" status="status"
                                    rendered="{!$CurrentPage.Parameters.type == 'sms'}"/>
                            </apex:selectList>   
                            <apex:actionStatus id="status" Style="">  
                                <apex:facet name="start">
                                   <img src="/img/loading.gif" />&nbsp;<span style="color:red;">Loading...</span>
                                </apex:facet>
                            </apex:actionStatus>
                        </apex:outputPanel>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>                
            </apex:pageBlockSection>
            <apex:pageBlockSection title="短信预览" columns="1" id="smsPreview" rendered="{!$CurrentPage.Parameters.type == 'sms'}">
                <apex:outputPanel >
                    <table width="100%">
                        <tr>
                            <td width="16%" align="right"><b><apex:outputLabel value="短信预览"/></b></td>
                            <td width="2%" align="center"></td>
                            <td width="80%" align="left">
                                <apex:inputTextarea id="message" value="{!templateMessage}" Style="width:500px" rows="5"/>
                            </td>
                        </tr>
                    </table>
                </apex:outputPanel>
            </apex:pageBlockSection>
        </apex:pageBlock>      
    </apex:form>
</apex:page>